#load @"..\paket-files\v-zubritsky\fsharp-common\PathUtils.fs"

open System.IO
open FSharpCommon.PathUtils

Directory.SetCurrentDirectory __SOURCE_DIRECTORY__

let curDir = Directory.GetCurrentDirectory()
let outputPath = normalizePath (@".\..\src\Client.fs") curDir

type ResourceType = 
    | Collection
    | Entity

type ResourceDescriptor = 
    { Name: string;
      Url: string;
      Type: ResourceType; }

let tpClientTemplate = """
(* THIS FILE IS AUTOGENERATED. ANY MANUAL MODIFICATIONS WILL BE LOST *)

namespace TpClient

[<AutoOpen>]
module Client = 
    $ResourceModules

    type TargetProcessClient(username, password) =
        let userInfo = { UserName = username; Password = password }
        
    $ClientMembers
"""

let entityRequestTemplate = """
module private $ResourceRequestModuleName = 
    type private Response = JsonProvider<@"$ResourceResponseSamplePath">
    let private url = "$ResourceUrl" 
    let private parser = 
        { new IResponseParser<Response.Root> with 
            member this.Parse responseBody = Response.Parse responseBody }

    let execute(userInfo, filters, pager) = getSingle(parser, url, userInfo, filters, pager) 
"""

let collectionRequestTemplate = """
module private $ResourceRequestModuleName = 
    type private Response = JsonProvider<@"$ResourceResponseSamplePath">
    let private url = "$ResourceUrl"  
    let private parser = 
        { new ICollectionResponseParser<Response.Item> with 
            member this.Parse responseBody = (Response.Parse responseBody).Items }

    let execute (userInfo, filters, pager) = getCollection(parser, url, userInfo, filters, pager) 
"""

let tpClientMemberTemplate = """
    member __.$ResourceMemberName(?filters, ?pager) = $ResourceRequestModuleName.execute(userInfo, filters, pager)
"""

let buildRequest(resource: ResourceDescriptor) = 
    let template = 
        match resource.Type with 
        | Entity -> entityRequestTemplate
        | Collection -> collectionRequestTemplate

    let resourceRequestModuleName = "GetContextRequest"
    let resourceResponseSamplePath = "JsonSamples/GetContext.json"
    let resourceUrl = "/api/v1/Context"
    
    template
        .Replace("$ResourceRequestModuleName", resourceRequestModuleName)
        .Replace("$ResourceResponseSamplePath", resourceResponseSamplePath)
        .Replace("$ResourceUrl", resourceUrl)

let buildTpClientMember(resource: ResourceDescriptor) = 
    let resourceMemberName = "GetContext"
    let resourceRequestModuleName = "GetContextRequest"

    tpClientMemberTemplate
        .Replace("$ResourceMemberName", resourceMemberName)        
        .Replace("$ResourceRequestModuleName", resourceRequestModuleName)

let buildTpClient(resources: ResourceDescriptor list) = 
    File.WriteAllText(outputPath, "hi")

buildTpClient [{Name = "Test"; Type = Entity; Url = "Test"}]
